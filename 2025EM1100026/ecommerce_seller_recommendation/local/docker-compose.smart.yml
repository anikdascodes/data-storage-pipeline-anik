version: '3.8'

services:
  # Full installation (includes Java, Spark, Python)
  # Use this if reviewer's system doesn't have Spark installed
  ecommerce-recommendation-full:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ecommerce_recommendation_full
    image: ecommerce-recommendation:full
    volumes:
      - ./configs:/app/configs
      - ./src:/app/src
      - ./scripts:/app/scripts
      - ./raw:/app/raw
      - ./processed:/app/processed
      - ./quarantine:/app/quarantine
      - ./logs:/app/logs
    environment:
      - SPARK_HOME=/opt/spark
      - JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
      - PYSPARK_PYTHON=/usr/bin/python3
    working_dir: /app
    stdin_open: true
    tty: true
    command: /bin/bash
    profiles:
      - full

  # Slim installation (only Python dependencies)
  # Use this if reviewer's system already has Spark/Java
  ecommerce-recommendation-slim:
    build:
      context: .
      dockerfile: Dockerfile.slim
    container_name: ecommerce_recommendation_slim
    image: ecommerce-recommendation:slim
    volumes:
      - ./configs:/app/configs
      - ./src:/app/src
      - ./scripts:/app/scripts
      - ./raw:/app/raw
      - ./processed:/app/processed
      - ./quarantine:/app/quarantine
      - ./logs:/app/logs
      # Mount host's Spark installation
      - ${SPARK_HOME:-/opt/spark}:/opt/spark:ro
    environment:
      - SPARK_HOME=${SPARK_HOME:-/opt/spark}
      - JAVA_HOME=${JAVA_HOME:-/usr/lib/jvm/java-11-openjdk-amd64}
      - PYSPARK_PYTHON=/usr/bin/python3
      - PATH=/opt/spark/bin:/opt/spark/sbin:$PATH
    working_dir: /app
    stdin_open: true
    tty: true
    command: /bin/bash
    profiles:
      - slim

# Usage Instructions:
# 
# Option 1: Full Installation (10-15 minutes build time)
#   docker compose -f docker compose.smart.yml --profile full build
#   docker compose -f docker compose.smart.yml --profile full up -d
#   docker compose -f docker compose.smart.yml exec ecommerce-recommendation-full bash
#   bash /app/scripts/run_all_pipelines.sh
#
# Option 2: Slim Installation (2-3 minutes build time, requires Spark on host)
#   export SPARK_HOME=/opt/spark  # Set to your Spark installation
#   export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
#   docker compose -f docker compose.smart.yml --profile slim build
#   docker compose -f docker compose.smart.yml --profile slim up -d
#   docker compose -f docker compose.smart.yml exec ecommerce-recommendation-slim bash
#   bash /app/scripts/run_all_pipelines.sh
#
# Stop:
#   docker compose -f docker compose.smart.yml --profile full down
#   docker compose -f docker compose.smart.yml --profile slim down
